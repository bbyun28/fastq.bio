function launchURL(e){var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="blob",t.onload=function(){var e=t.response;e.lastModifiedDate=new Date,e.name="Sample.fastq",FILES=[e],launch()},t.send()}function launch(){return FASTQ.isValidFileName(FILES[0])?(document.querySelector(".footer").style.display="none",document.querySelector(".spinner").style.display="block",void setTimeout(function(){FASTQ.getNextChunk(FILES[0],20,{preread:function(){document.querySelector(".spinner").style.display="block",document.querySelector(".containerMain").style.display="none",document.querySelector(".containerPreview").style.display="block",document.querySelector("#headerBtnNewFile").style.display="none",document.querySelector("#headerBtnNewFile").disabled=!0},postread:function(e){plotStats(e),launch()},lastread:function(){document.querySelector(".spinner").style.display="none",document.querySelector("#headerBtnNewFile").style.display="block",document.querySelector("#headerBtnNewFile").disabled=!1}})},500)):void alert("Error: please choose a FASTQ file.")}function plotStats(e){var t={modeBarButtonsToRemove:["sendDataToCloud","autoScale2d","hoverClosestCartesian","hoverCompareCartesian","lasso2d","select2d","zoom2d","pan2d","zoomIn2d","zoomOut2d","resetScale2d","toggleSpikelines"],displaylogo:!1,showTips:!0},n=Math.round(e.reads/1e3),a={A:[],C:[],G:[],T:[],N:[]};e.nucl.map(function(e,t){var n=e.A+e.C+e.G+e.T;a.A[t]=Math.round(e.A/n*1e3)/1e3,a.C[t]=Math.round(e.C/n*1e3)/1e3,a.G[t]=Math.round(e.G/n*1e3)/1e3,a.T[t]=Math.round(e.T/n*1e3)/1e3,a.N[t]=Math.round(e.N/n*1e3)/1e3});var l=[];e.qual.map(function(e,t){l[t]=e.reduce(function(e,t){return e+t})/e.length}),Plotly.newPlot("plot-per-base-sequence-content",[{y:a.A,name:"A"},{y:a.C,name:"C"},{y:a.G,name:"G"},{y:a.T,name:"T"}],{title:"Per Base Sequence Content<br><i>Sampled first "+n+"K reads</i>",xaxis:{title:"Read Position"},yaxis:{title:"Composition"}},t),Plotly.newPlot("plot-per-base-sequence-quality",[{y:l}],{title:"Per Base Sequence Quality<br><i>Sampled first "+n+"K reads</i>",xaxis:{title:"Read Position"},yaxis:{title:"Base Quality",range:[0,1.1*Math.max.apply(Math,l)]},showlegend:!1},t),Plotly.newPlot("plot-per-base-N-content",[{y:a.N,name:"N"}],{title:"Per Base N Content<br><i>Sampled first "+n+"K reads</i>",xaxis:{title:"Read Position"},yaxis:{title:"Frequency",range:[0,1]}},t),Plotly.newPlot("plot-dist-gc-content-per-read",[{x:e.avgGC,type:"histogram",xbins:{start:0,end:1,size:.05}}],{title:"Average GC Content per Read<br><i>Sampled first "+n+"K reads</i>",xaxis:{title:"GC Content"},yaxis:{title:"Counts"},showlegend:!1},t),Plotly.newPlot("plot-dist-qual-per-read",[{x:e.avgQual,type:"histogram"}],{title:"Average Quality Score per Read<br><i>Sampled first "+n+"K reads</i>",xaxis:{title:"Quality Score"},yaxis:{title:"Counts"},showlegend:!1},t),Plotly.newPlot("plot-dist-seq-length",[{x:e.seqlen,type:"histogram"}],{title:"Sequence Length Distribution<br><i>Sampled first "+n+"K reads</i>",xaxis:{title:"Sequence Length"},yaxis:{title:"Counts"},showlegend:!1},t)}function dragover_handler(e){e.preventDefault(),document.querySelector("body").style.border="2px dashed #2663a8"}function dragend_handler(e){e.preventDefault(),document.querySelector("body").style.border="0"}function drop_handler(e){e.preventDefault(),document.querySelector("body").style.border="0";var t={},n=e.dataTransfer;n.items&&(t="file"==n.items[0].kind?n.items[0].getAsFile():n.files[i]),FILES=[t],FASTQ.reset(),launch()}for(var SAMPLE="data/NA12878_U0a_CGATGT_L001_R1_005.fastq",FILES={},arrEl=document.querySelectorAll(".btnNewFile"),i=0;i<arrEl.length;i++)arrEl[i].addEventListener("click",function(){document.querySelector("#upload").click()});document.querySelector("#upload").addEventListener("change",function(){FILES=this.files,launch()}),document.querySelector("#btnSample").addEventListener("click",function(){launchURL(SAMPLE)});var tmp={},FASTQ=function(){function e(e){return null!=e&&"name"in e&&e.name.match(r)?!0:!1}function t(t,n){return e(t)?n[0].match(/^@/)&&n[1].length==n[3].length:!1}function n(e,t,n){e.name in u||(u[e.name]=0,c[e.name]=null,m[e.name]=0);var l=e.name.match(/.gz$/);if(l&&(u[e.name]=0,c[e.name]=null),m[e.name]>t)return void("lastread"in n&&n.lastread());m[e.name]++;var r=new FileReader,d=u[e.name],p=Math.min(d+o,e.size),n=n||{};return l&&(p=o*m[e.name]/4,i=s*m[e.name]*10),"preread"in n&&n.preread(),d>=p||-1==d||-1==p?void("lastread"in n&&n.lastread()):(r.readAsBinaryString(e.slice(d,p)),void(r.onload=function(t){a(e,r),"postread"in n&&n.postread(c[e.name])}))}function a(e,n){var a={},l=n.result,r=i,o=e.name.match(/.gz$/),s=c[e.name];if(a=null==s?{reads:0,avgGC:[],avgQual:[],seqlen:[],nucl:[],qual:[]}:s,o&&(l=new TextDecoder("utf-8").decode(pako.inflate(l))),l=l.split("\n"),l.length<r&&(r=l.length-l.length%4),r-=4,4>r)return void(u[e.name]=-1);for(var m=0;r>m;m+=4){if(!t(e,[l[0],l[1],l[2],l[3]]))return console.log("Invalid FASTQ chunk"),void(u[e.name]=-1);var p=l[m+1],y=l[m+3];a.reads++,a.seqlen.push(p.length);for(var h=0,f=0,S=0,g=0,v=0;v<p.length;v++){0==m&&null==a.nucl[v]&&(a.nucl[v]={A:0,C:0,G:0,T:0,N:0},a.qual[v]=[]);var q=p[v],C=y[v].charCodeAt()-d;a.nucl[v][q]++,a.qual[v].push(C),h+="C"==p[v]||"G"==p[v]?1:0,f++,S+=C,g++}a.avgGC.push(Math.round(h/f*1e3)/1e3),a.avgQual.push(Math.round(S/g))}console.log("Read "+r+"lines -- "+a.reads+" reads total");for(var b=0,m=0;r>m;m++)b+=l[m].length+1;return o||(u[e.name]+=b),c[e.name]=a,!0}function l(){i=s,u={},c={},m={}}var r=/.fastq|.fq|.fastq.gz|.fq.gz/,o=512e3,i=1e4,s=1e4,d=33,u={},c={},m={};return{isValidFileName:e,getNextChunk:n,reset:l}}();
